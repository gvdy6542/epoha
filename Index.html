<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Отчитане на магазин</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:#f6f8fa;color:#0f172a}
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .card h3{margin:0 0 8px;font-size:16px}
    label{display:block;font-size:12px;margin-bottom:6px;color:#475569}
    input,select,textarea,button{width:100%;padding:8px;border:1px solid #d0d7de;border-radius:8px;font-size:14px}
    button{cursor:pointer}
    .btn{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left;font-size:13px}
    th{background:#f8fafc}
    .stat{display:flex;gap:8px;align-items:baseline}
    .stat .v{font-weight:700}
    .right{justify-self:end}
    .muted{color:#64748b}
    .ok{color:#16a34a}
    .bad{color:#dc2626}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="margin-bottom:12px">
      <div class="card" style="grid-column: span 12; display:grid; grid-template-columns:repeat(12,1fr); gap:12px; align-items:end;">
        <div style="grid-column: span 3">
          <label>Магазин</label>
          <select id="store"></select>
        </div>
        <div style="grid-column: span 3">
          <label>Дата</label>
          <input type="date" id="date" />
        </div>
        <div class="right" style="grid-column: span 6; display:flex; gap:8px; justify-content:flex-end; align-items:end">
          <button class="btn" onclick="refreshAll()">Обнови</button>
          <button onclick="openWebApp()">Отвори в нов таб</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card" style="grid-column: span 5">
        <h3>Операция (приход/разход)</h3>
        <div class="grid3">
          <div>
            <label>Тип</label>
            <select id="tx_type">
              <option value="INCOME">Приход</option>
              <option value="EXPENSE">Разход</option>
            </select>
          </div>
          <div>
            <label>Метод</label>
            <select id="tx_method"></select>
          </div>
          <div>
            <label>Категория</label>
            <select id="tx_category"></select>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Сума</label>
            <input type="number" id="tx_amount" step="0.01" />
          </div>
          <div>
            <label>Описание</label>
            <input type="text" id="tx_desc" />
          </div>
        </div>
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" id="btn_add" onclick="addTx()">Добави</button>
        </div>
      </div>

      <div class="card" style="grid-column: span 7">
        <h3>Обобщение за деня</h3>
        <div id="summary" class="grid3"></div>
        <div class="muted" style="margin-top:8px" id="summary_note"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card" style="grid-column: span 5">
        <h3>Броене на каса</h3>
        <div id="denoms" class="grid3"></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <div class="stat">Декларирани пари в каса: <span class="v" id="declared">0.00</span> лв</div>
          <button class="btn" onclick="saveCount()">Запиши броене</button>
        </div>
      </div>

      <div class="card" style="grid-column: span 7">
        <h3>Приключване на ден</h3>
        <label>Бележка</label>
        <textarea id="close_note" rows="3" placeholder="Коментар"></textarea>
        <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end; align-items:center">
          <div class="muted">Използва декларираната сума от броенето.</div>
          <button class="btn" onclick="closeDay()">Приключи деня</button>
        </div>
        <div id="close_result" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="card" style="grid-column: span 12">
        <h3>Последни операции</h3>
        <table>
          <thead>
            <tr>
              <th>Час</th><th>Тип</th><th>Метод</th><th>Категория</th><th>Описание</th><th>Сума</th><th>Потребител</th>
            </tr>
          </thead>
          <tbody id="tx_rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let META = null;

    function openWebApp(){
      window.open(location.href, '_blank');
    }

    function today(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    function money(n){ return (Number(n)||0).toFixed(2); }

    function byId(id){ return document.getElementById(id); }

    function setDeclared(){
      let total = 0;
      const boxes = document.querySelectorAll('[data-denom]');
      boxes.forEach(b=>{
        const d = Number(b.dataset.denom);
        const q = Number(b.value||0);
        total += d*q;
      });
      byId('declared').textContent = money(total);
      return total;
    }

    function fillDenoms(){
      const wrap = byId('denoms');
      wrap.innerHTML = '';
      META.denoms.forEach(d => {
        const div = document.createElement('div');
        div.innerHTML = `
          <label>${d.toFixed(2)} лв – брой</label>
          <input type="number" min="0" step="1" data-denom="${d}" value="0" oninput="setDeclared()" />
        `;
        wrap.appendChild(div);
      });
      setDeclared();
    }

    function fillMeta(meta){
      META = meta;
      // магазини
      const s = byId('store');
      s.innerHTML = META.stores.map(v=>`<option value="${v}">${v}</option>`).join('');
      // методи
      const m = byId('tx_method');
      m.innerHTML = META.methods.map(v=>`<option value="${v}">${v}</option>`).join('');
      // категории (динамично спрямо тип)
      refillCategories();
      // дата
      byId('date').value = today();
      fillDenoms();
      refreshAll();
    }

    function refillCategories(){
      const type = byId('tx_type').value;
      const c = byId('tx_category');
      const arr = (META.categories[type]||[]);
      c.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    }

    function addTx(){
      const btn = byId('btn_add');
      btn.disabled = true;
      const payload = {
        date: byId('date').value,
        store: byId('store').value,
        type: byId('tx_type').value,
        method: byId('tx_method').value,
        category: byId('tx_category').value,
        description: byId('tx_desc').value,
        amount: Number(byId('tx_amount').value||0)
      };
      google.script.run.withSuccessHandler(()=>{
        byId('tx_amount').value='';
        byId('tx_desc').value='';
        refreshAll();
        btn.disabled = false;
      }).withFailureHandler(err=>{
        alert(err.message||err);
        btn.disabled = false;
      }).addTransaction(payload);
    }

    function saveCount(){
      const counts = {};
      document.querySelectorAll('[data-denom]').forEach(b=>{
        counts[b.dataset.denom] = Number(b.value||0);
      });
      const payload = { date: byId('date').value, store: byId('store').value, counts };
      google.script.run.withSuccessHandler(res=>{
        byId('declared').textContent = money(res.total);
        alert('Броенето е записано.');
      }).withFailureHandler(err=> alert(err.message||err)).saveCashCount(payload);
    }

    function closeDay(){
      const declared = Number(byId('declared').textContent.replace(',','.'))||0;
      const payload = {
        date: byId('date').value,
        store: byId('store').value,
        declaredCash: declared,
        note: byId('close_note').value
      };
      google.script.run.withSuccessHandler(res=>{
        // Разлика в касата се отбелязва като проблем, ако не е нула
        const diffCls = res.diff === 0 ? 'ok' : 'bad';
        byId('close_result').innerHTML = `
          <div>Очаквани пари в каса: <b>${money(res.expectedCash)}</b> лв</div>
          <div>Декларирани пари в каса: <b>${money(res.declared)}</b> лв</div>
          <div>Разлика: <b class="${diffCls}">${money(res.diff)}</b> лв</div>
        `;
        refreshAll();
      }).withFailureHandler(err=> alert(err.message||err)).closeDay(payload);
    }

    function refreshAll(){
      const d = byId('date').value;
      const s = byId('store').value;
      // summary
      google.script.run.withSuccessHandler(drawSummary).withFailureHandler(e=>console.log(e)).getDailySummary(d, s);
      // tx list
      const q = {dateFrom:d, dateTo:d, store:s, limit:200};
      google.script.run.withSuccessHandler(drawTx).withFailureHandler(e=>console.log(e)).listTransactions(q);
    }

    function drawSummary(s){
      const el = byId('summary');
      const parts = [
        {label:'Продажби – Каса', v: s.sales.CASH||0},
        {label:'Продажби – Карта', v: s.sales.CARD||0},
        {label:'Продажби – Банка', v: s.sales.BANK||0},
        {label:'Разходи – Каса', v: s.expenses.CASH||0},
        {label:'Разходи – Карта', v: s.expenses.CARD||0},
        {label:'Разходи – Банка', v: s.expenses.BANK||0},
      ];
      el.innerHTML = parts.map(p=>`<div class="card"><div class="stat"><span>${p.label}:</span> <span class="v">${money(p.v)} лв</span></div></div>`).join('');
      byId('summary_note').textContent = `Очаквани пари в каса: ${money(s.expectedCash)} лв`;
    }

    function drawTx(rows){
      const tb = byId('tx_rows');
      tb.innerHTML = rows.map(r=>`<tr>
        <td>${new Date(r.timestamp).toLocaleTimeString()}</td>
        <td>${r.type==='INCOME'?'Приход':'Разход'}</td>
        <td>${r.method}</td>
        <td>${r.category||''}</td>
        <td>${r.description||''}</td>
        <td>${money(r.amount)}</td>
        <td class="muted">${r.user||''}</td>
      </tr>`).join('');
    }

    // INIT
    google.script.run.withSuccessHandler(fillMeta).getMeta();
    byId('tx_type').addEventListener('change', refillCategories);
  </script>
</body>
</html>
